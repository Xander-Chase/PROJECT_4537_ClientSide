<!-- adminDashboard.html -->
<!DOCTYPE html>
<html>
<head>
  <title>Start Your Adventure</title>
  <link rel="stylesheet" href="./public/styles/styles.css">  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body onload="NavigateUserProperlyKick()">
  <header id="header"></header>

  <main id="mainContent " class="col">
      <div class="row">
        <div class="text-center main_container shadow-lg scrollable">
          <h1 class="display-5 fw-bold text-body-emphasis">All Endpoints</h1>
          <table class="table">
            <thead>
              <tr>
                <th scope="col">Method</th>
                <th scope="col">Endpoint</th>
                <th scope="col">Count</th>
              </tr>
            </thead>
            <tbody id="endpoints-table">
              <!-- Had help with GPT for this one - Teddy -->
              <template id="endpoints-table-template">
                <tr>
                  <td class="endpoint-method"></td>
                  <td class="endpoint-name"></td>
                  <td class="endpoint-count"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
  
      </div>

      <div class="row" id="user-table-div">
        
        <div class="text-center main_container shadow-lg scrollable">
          <h1 class="display-5 fw-bold text-body-emphasis">All Users</h1>
          <table class="table">
            <thead>
              <tr>
                <th scope="col">#</th>
                <th scope="col">Username</th>
                <th scope="col">Email</th>
              </tr>
            </thead>
            <tbody id="userTable">
              <!-- Had help with GPT for this one - Teddy -->
              <template id="user-table-template">
                <tr>
                  <td class="user-id"></td>
                  <td class="user-name"></td>
                  <td class="user-email"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
        
        <div class="text-center main_container shadow-lg scrollable">
          <h1 class="display-5 fw-bold text-body-emphasis">Roles</h1>
          <table class="table">
            <thead>
              <tr>
                <th scope="col">User #</th>
                <th scope="col">Role Info</th>
              </tr>
            </thead>
            <tbody id="role-table">
              <!-- Had help with GPT for this one - Teddy -->
              <template id="role-table-template">
                <tr>
                  <td class="user-id"></td>
                  <td class="role"></td>

                </tr>
              </template>
            </tbody>
          </table>
        </div>
        
        <div class="text-center main_container shadow-lg scrollable">
          <h1 class="display-5 fw-bold text-body-emphasis">API Usage</h1>
          <table class="table">
            <thead>
              <tr>
                <th scope="col">User #</th>
                <th scope="col">API Count / 20</th>
              </tr>
            </thead>
            <tbody id="apiUsage-table">
              <!-- Had help with GPT for this one - Teddy -->
              <template id="apiUsage-table-template">
                <tr>
                  <td class="user-id"></td>
                  <td class="api-count"></td>

                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
  </main>

  <script src="./public/scripts/constants.js"></script>
  <script src="./public/scripts/Utils.js"></script>
  <script src="./public/scripts/authenicateScript.js"></script>
  <script>
    // Actual Script Functionality
    const userTable = document.getElementById("userTable");
    const endpointsTable = document.getElementById("endpoints-table");
    const apiUsage = document.getElementById("apiUsage-table");
    const roleTable = document.getElementById("role-table");

    const getUsers = async () => {
      const userTemplate = document.getElementById("user-table-template");
      const apiUsageTemplate = document.getElementById("apiUsage-table-template");
      const roleTemplate = document.getElementById("role-table-template");
      const users = await Utils.GetFetch(`${API_URL}/api/admin/users`);

      const data = await users.json();
      arr = data.users;
      arr.forEach((element, index) => {
        const userRowClone = userTemplate.content.cloneNode(true);
        userRowClone.querySelector(".user-id").textContent = ++index;
        userRowClone.querySelector(".user-name").textContent = element.username;
        userRowClone.querySelector(".user-email").textContent = element.email;
        userTable.appendChild(userRowClone);

        const roleRowClone = roleTemplate.content.cloneNode(true);
        roleRowClone.querySelector(".user-id").textContent = index;
        roleRowClone.querySelector(".role").textContent = `${element.role}`.toUpperCase();

        roleTable.appendChild(roleRowClone);

        const apiUsageRowClone = apiUsageTemplate.content.cloneNode(true);
        apiUsageRowClone.querySelector(".user-id").textContent = index;
        apiUsageRowClone.querySelector(".api-count").textContent = element.api_consumptions;

        apiUsage.appendChild(apiUsageRowClone);
      });
    };

    const getEndpoints = async () => {
      const endpointTemplate = document.getElementById("endpoints-table-template");
      // const endpoints = await Utils.GetFetch(`${API_URL}/api/admin/endpoints`);

      // const data = await endpoints.json();
      // arr = data.endpoints;
      arr = [{
        method: "GET",
        endpoint: "/api/admin/users",
        count: 1
      }, {
        method: "GET",
        endpoint: "/api/admin/endpoints",
        count: 1
      }, {
        method: "GET",
        endpoint: "/api/admin/roles",
        count: 1
      }, {
        method: "GET",
        endpoint: "/api/admin/roles/:id",
        count: 1
      }, {
        method: "GET",
        endpoint: "/api/admin/users/:id",
        count: 1
      }, {
        method: "GET",
        endpoint: "/api/admin/users/:id/roles",
        count: 1
      }, {
        method: "POST",
        endpoint: "/api/admin/roles",
        count: 1
      }, {
        method: "POST",
        endpoint: "/api/admin/users",
        count: 1
      }, {
        method: "POST",
        endpoint: "/api/admin/users/:id/roles",
        count: 1
      }, {
        method: "PUT",
        endpoint: "/api/admin/roles/:id",
        count: 1
      }, {
        method: "PUT",
        endpoint: "/api/admin/users/:id",
        count: 1
      }, {
        method: "DELETE",
        endpoint: "/api/admin/roles/:id",
        count: 1
      }, {
        method: "DELETE",
        endpoint: "/api/admin/users/:id",
        count: 1
      }]
      arr.forEach((element) => {
        const endpointRowClone = endpointTemplate.content.cloneNode(true);
        endpointRowClone.querySelector(".endpoint-method").textContent = element.method;
        endpointRowClone.querySelector(".endpoint-name").textContent = element.endpoint;
        endpointRowClone.querySelector(".endpoint-count").textContent = element.count;

        endpointsTable.appendChild(endpointRowClone);
      });
    };
    getUsers();
    getEndpoints();

  </script>

  <script type="module">

    import { loadHeader, GetUserPromise } from './public/scripts/loadComponents.js';

    loadHeader();
    let userData = await GetUserPromise();

    if (userData.user.role !== "admin")
    {
      window.location.href = 'home.html';
    }
    
  </script>

    <script src="./public/scripts/themeChanger.js"></script>
</body>
</html>
