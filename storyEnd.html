<!-- story.html -->
<!DOCTYPE html>
<html>
<head>
  <title>Your Adventure Story</title>
  <link rel="stylesheet" href="./public/styles/styles.css">
  <link rel="stylesheet" href="./public/styles/storyEnd.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body onload="NavigateUserProperlyKick()" class="isa_col">
  <header id="header">
    <!-- Import Component -->
  </header>
  <div id="body-container" class="isa_row justify-content-evenly align">
    <div class="isa_col shadow-lg rounded p-3 text-center">
      <h1>Congratulations, you have reached to the end of the story!</h1>
      <hr/>
      <br/>
      <h2>What is your next path forward adventurer?</h2>
      <div class="content align-self-center">
        <h3 id="storyTitle">Story Title</h3>
        <p id="storyDescription">
          "Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum."
        </p>

      </div>
      <div class="isa_row justify-content-between align-self-center" id="buttons">
        <button class="btn btn-primary" id="saveStory">Save Story</button>
        <br/>
        <button class="btn btn-primary" id="backButton">Home</button>
      </div>
    </div>
  </div>

  <script src="./public/scripts/constants.js"></script>
  <script src="./public/scripts/Utils.js"></script>'
  <script src="./public/scripts/authenicateScript.js"></script>
  <script>

    // Back Button Functionality
    document.getElementById("backButton").onclick = function() {
      window.location.href = "home.html";
    };
    // Retrieve the story text and prompt options
    let storyText = localStorage.getItem('storyText') || '';
    const promptOptions = JSON.parse(localStorage.getItem('promptOptions'));

    if (storyText) {
      document.getElementById('story_description').innerText = Utils.cleanString(storyText);
    } else {
      alert("No story text found, try typing a prompt!");
      // If no story text is found, redirect back to the index page
      window.location.href = 'home.html';
    }

    // Display the prompt options
    const promptChoicesDiv = document.getElementById('prompt_choices');
    if (promptOptions && promptOptions.length > 0) {
      promptChoicesDiv.innerHTML = ''; // Clear existing prompts
      promptOptions.forEach((suggestion, index) => {
        const button = document.createElement('button');
        button.classList.add('ai_generated_prompt');
        button.innerHTML = `Option ${index + 1}: ${Utils.cleanString(suggestion)}...`;
        promptChoicesDiv.appendChild(button);

        // Add event listener for button click
        button.addEventListener('click', async () => {
          
          // Disable Buttons
          const buttons = document.getElementsByClassName("ai_generated_prompt");
          for (let i = 0; i < buttons.length; i++) {
            buttons[i].disabled = true;
          }

          // Handle prompt selection
          try {
            const response = await Utils.PostFetch(`${API_URL}/api/generate-story`, {
              prompt: `${Utils.cleanString(suggestion)}`,
            });
            
            if (response.ok) {
              const data = await response.json();
              const newStoryPart = data.generatedStoryPart;
              storyText = newStoryPart; // Replace the story text with the new part
              localStorage.setItem('storyText', storyText);
              localStorage.setItem('promptOptions', JSON.stringify(data.promptOptions));

              // Update current page number
              let currentPageNumber = parseInt(localStorage.getItem('currentPageNumber')) || 1;
              currentPageNumber += 1;
              localStorage.setItem('currentPageNumber', currentPageNumber.toString());

              // Update the displayed story and prompts without page reload
              document.getElementById('story_description').innerText = storyText;
              displayPrompts(data.promptOptions);
              pageNumberElement.innerHTML = `Page ${currentPageNumber}`;
            } else {
              alert('Error generating the next part of the story');
            }
          } catch (error) {
            // re-enable buttons
            for (let i = 0; i < buttons.length; i++) {
              buttons[i].disabled = false;
            }
            console.error('Error:', error);
            alert('An error occurred while generating the next part of the story.');
          }
        });
      });
    } else {
      // If no prompts are found, show a message
      promptChoicesDiv.innerHTML = '<p>No prompts available.</p>';
    }

    // Function to display new prompts without reloading the page
    function displayPrompts(newPromptOptions) {
      promptChoicesDiv.innerHTML = ''; // Clear existing prompts
      newPromptOptions.forEach((suggestion, index) => {
        const button = document.createElement('button');
        button.classList.add('ai_generated_prompt');
        button.innerHTML = `Option ${index + 1}: ${Utils.cleanString(suggestion)}`;
        promptChoicesDiv.appendChild(button);

        // Add event listener for button click
        button.addEventListener('click', async () => {

          // Disable Buttons
          const buttons = document.getElementsByClassName("ai_generated_prompt");
          for (let i = 0; i < buttons.length; i++) {
            buttons[i].disabled = true;
          }

          // Handle prompt selection
          try {
            const response = await PostFetch(`${API_URL}/api/generate-story`, {
              prompt: `${Utils.cleanString(suggestion)}`,
            });

            if (response.ok) {
              const data = await response.json();
              const newStoryPart = data.generatedStoryPart;
              storyText = newStoryPart; // Replace the story text with the new part
              localStorage.setItem('storyText', storyText);
              localStorage.setItem('promptOptions', JSON.stringify(data.promptOptions));

              // Update current page number
              let currentPageNumber = parseInt(localStorage.getItem('currentPageNumber')) || 1;
              currentPageNumber += 1;
              localStorage.setItem('currentPageNumber', currentPageNumber.toString());

              // Update the displayed story and prompts without page reload
              document.getElementById('story_description').innerText = storyText;
              displayPrompts(data.promptOptions);
              pageNumberElement.innerHTML = `Page ${currentPageNumber}`;
            } else {
              alert('Error generating the next part of the story');
            }
          } catch (error) {
            // re-enable buttons
            for (let i = 0; i < buttons.length; i++) {
              buttons[i].disabled = false;
            }
            console.error('Error:', error);
            alert('An error occurred while generating the next part of the story.');
          }
        });
      });
    }

    // Update other elements as needed
    // const userNameHeader = document.getElementById('userName_header');

    // Update page number
    const pageNumberElement = document.getElementById('page_number');
    const currentPageNumber = parseInt(localStorage.getItem('currentPageNumber')) || 1;
    pageNumberElement.innerHTML = `Page ${currentPageNumber}`;

    // Back Button Functionality
    document.getElementById('backButton').addEventListener('click', () => {
      window.location.href = 'home.html';
    });
  </script>
  <script type="module">

    import { loadHeader } from './public/scripts/loadComponents.js';
    loadHeader();

    // let userData = await GetUserPromise();

    // userNameHeader.innerHTML = `Welcome, ${userData.user.username}! To your story!`;

    
  </script>
  <script src="./public/scripts/themeChanger.js"></script>
</body>
</html>
